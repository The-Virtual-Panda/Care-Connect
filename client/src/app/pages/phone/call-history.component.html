<!-- Retention / Policy Banner -->
<p class="mb-4 flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400">
    Call history is retained for up to <span class="font-medium">13 months.</span> For older records, please contact support.
</p>

<app-alert />

<p-table
    #dt
    [value]="calls"
    sortField="startTime"
    [sortOrder]="-1"
    dataKey="sid"
    [rows]="20"
    [loading]="isLoading"
    showLoader="false"
    [rowHover]="true"
    [paginator]="true"
    [globalFilterFields]="['sid']"
    stripedRows>
    <ng-template #caption>
        <div class="flex flex-col items-center justify-between sm:flex-row">
            <div class="flex flex-wrap items-start gap-2">
                <p-iconfield iconPosition="left">
                    <p-inputicon>
                        <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input
                        pInputText
                        type="text"
                        (input)="onGlobalFilter(dt, $event)"
                        placeholder="Look up by call ID" />
                </p-iconfield>
                <p-select
                    [options]="dateRangeOptions"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="selectedDateRangeOption"
                    [showClear]="true"
                    (onChange)="selectedDateRangeOption !== undefined ? reload() : null"
                    [style]="{ 'min-width': '150px' }"
                    placeholder="Timeframe" />
                @if (selectedDateRangeOption === undefined) {
                    <p-datepicker
                        selectionMode="range"
                        placeholder="Filter by date range"
                        [(ngModel)]="customDateRange"
                        (ngModelChange)="reload()"
                        [showClear]="true"
                        dateFormat="mm/dd/yy" />
                }
                <p-select
                    [options]="statusOptions"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="selectedStatus"
                    [showClear]="true"
                    (onChange)="reload()"
                    [style]="{ 'min-width': '150px' }"
                    placeholder="Select Status" />
                <input
                    pInputText
                    type="text"
                    [(ngModel)]="fromFilter"
                    (ngModelChange)="onChangeDebounce()"
                    placeholder="From" />
                <input
                    pInputText
                    type="text"
                    [(ngModel)]="toFilter"
                    (ngModelChange)="onChangeDebounce()"
                    placeholder="To" />
            </div>
            <div class="mt-2 flex items-center sm:mt-0">
                <p-button
                    variant="outlined"
                    icon="pi pi-filter-slash"
                    label="Clear Filters"
                    class="mr-2 ml-auto"
                    (click)="clearFilters(dt)" />
                <p-button
                    type="button"
                    icon="pi pi-refresh"
                    severity="secondary"
                    (click)="reload()" />
            </div>
        </div>
    </ng-template>
    <ng-template #header>
        <tr>
            <th pSortableColumn="startTime">
                <div class="flex items-center gap-2">
                    Date/Time
                    <p-sortIcon field="startTime" />
                </div>
            </th>
            <th pSortableColumn="status">
                <div class="flex items-center gap-2">
                    Status
                    <p-sortIcon field="status" />
                </div>
            </th>
            <th pSortableColumn="direction">
                <div class="flex items-center gap-2">
                    Direction
                    <p-sortIcon field="direction" />
                </div>
            </th>
            <th pSortableColumn="from">
                <div class="flex items-center gap-2">
                    From
                    <p-sortIcon field="from" />
                </div>
            </th>
            <th pSortableColumn="to">
                <div class="flex items-center gap-2">
                    To
                    <p-sortIcon field="to" />
                </div>
            </th>
            <th pSortableColumn="duration">
                <div class="flex items-center gap-2">
                    Duration
                    <p-sortIcon field="duration" />
                </div>
            </th>
            <th pSortableColumn="price">
                <div class="flex items-center gap-2">
                    Cost
                    <p-sortIcon field="price" />
                </div>
            </th>
            <th pSortableColumn="sid">
                <div class="flex items-center gap-2">
                    ID
                    <p-sortIcon field="sid" />
                </div>
            </th>
        </tr>
    </ng-template>
    <ng-template
        #body
        let-call>
        <tr>
            <td>{{ call.startTime | date: 'MMM d, y h:mm a' }}</td>
            <td>
                <p-tag
                    [value]="call.status"
                    [severity]="getStatusSeverity(call.status)"></p-tag>
            </td>
            <td>
                <span [ngClass]="getDirectionClass(call.direction)">
                    <i
                        [class]="getDirectionIcon(call.direction)"
                        class="mr-2"></i>
                    {{ formatDirection(call.direction) }}
                </span>
            </td>
            <td>{{ call.fromFormatted || call.from }}</td>
            <td>{{ call.toFormatted || call.to }}</td>
            <td>{{ formatDuration(call.duration) }}</td>
            <td>
                {{ formatPrice(call.price) }}
            </td>
            <td>{{ call.sid }}</td>
        </tr>
    </ng-template>
    <ng-template #emptymessage>
        <tr>
            <td colspan="8">No call history found for your organization</td>
        </tr>
    </ng-template>
    <ng-template #loadingbody>
        <tr>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
        </tr>
        <tr>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
        </tr>
        <tr>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
        </tr>
    </ng-template>
</p-table>
